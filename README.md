# AI Pipeline

Мультиагентный конвейер разработки на базе Claude AI. Система из трёх ИИ-агентов автоматизирует полный цикл: получает задачу текстом, пишет код, проводит код-ревью, запускает тесты и мержит результат.

## Содержание

- [Как это работает](#как-это-работает)
- [Архитектура](#архитектура)
- [Требования](#требования)
- [Установка](#установка)
- [Конфигурация](#конфигурация)
- [CLI-команды](#cli-команды)
  - [run — запуск задачи](#run--запуск-задачи)
  - [tasks — список задач](#tasks--список-задач)
  - [show — детали задачи](#show--детали-задачи)
  - [retry — повтор упавшей задачи](#retry--повтор-упавшей-задачи)
- [Жизненный цикл задачи](#жизненный-цикл-задачи)
- [Агенты](#агенты)
  - [Coder Agent](#coder-agent)
  - [Reviewer Agent](#reviewer-agent)
  - [Test Runner](#test-runner)
- [Сбор контекста репозитория](#сбор-контекста-репозитория)
- [База данных](#база-данных)
- [Git-операции](#git-операции)
- [Структура проекта](#структура-проекта)
- [Подробное описание каждого модуля](#подробное-описание-каждого-модуля)
- [Переменные окружения](#переменные-окружения)
- [Примеры использования](#примеры-использования)
- [Устранение неполадок](#устранение-неполадок)
- [Технический стек](#технический-стек)

---

## Как это работает

```
Вы: "добавь валидацию email в форму регистрации"
          │
          ▼
   ┌──────────────┐
   │ Pipeline CLI  │  ai-pipeline run "..." --repo ~/my-app
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │ Сбор контекста│  Читает структуру проекта, ключевые файлы, конфиги
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐
   │ Coder Agent  │  Claude API → генерирует файлы → коммит в ветку
   └──────┬───────┘
          │
          ▼
   ┌──────────────┐     ┌─── reject ──→ обратно к Coder (макс. 3 попытки)
   │Reviewer Agent│─────┤
   └──────┬───────┘     └─── approve ──→ далее
          │
          ▼
   ┌──────────────┐     ┌─── fail ────→ обратно к Coder (макс. 3 попытки)
   │ Lint + Тесты │─────┤
   └──────┬───────┘     └─── pass ────→ далее
          │
          ▼
   ┌──────────────┐
   │    Merge     │  Автоматический мерж в main (или оставить ветку)
   └──────────────┘
```

Ключевая идея: задача проходит через конвейер агентов. Если ревьюер отклонил код или тесты упали — кодер получает обратную связь и пробует снова (до 3 попыток). Каждая попытка создаёт чистую ветку от main.

---

## Архитектура

Система построена как стейт-машина с чётким разделением ответственности:

| Компонент | Назначение |
|-----------|-----------|
| **Pipeline Runner** | Оркестратор — управляет переходами между стадиями |
| **Coder Agent** | Генерирует код по задаче и контексту проекта |
| **Reviewer Agent** | Ревьюит git diff без знания исходной задачи |
| **Test Runner** | Запускает ESLint и тесты проекта |
| **Context Gatherer** | Собирает контекст целевого репозитория для агентов |
| **Git Operations** | Управляет ветками, коммитами, диффами, мержами |
| **Task Repository** | Хранит задачи и логи в SQLite |

---

## Требования

- **Node.js** >= 18
- **Git** в PATH
- **Anthropic API Key** (Claude API)
- Целевой репозиторий должен быть git-репозиторием с чистым рабочим деревом (без незакоммиченных изменений)

---

## Установка

```bash
# Клонировать проект
git clone <repo-url> ai-pipeline
cd ai-pipeline

# Установить зависимости
npm install

# Собрать TypeScript
npm run build

# Создать .env файл
cp .env.example .env
# Вписать свой ANTHROPIC_API_KEY в .env

# (Опционально) Установить глобально для использования как CLI
npm link
```

После `npm link` команда `ai-pipeline` станет доступна глобально в терминале.

Без `npm link` можно запускать напрямую:

```bash
node dist/index.js run "описание задачи" --repo ~/my-project
```

---

## Конфигурация

Конфигурация загружается из трёх источников (по приоритету):

1. **CLI-флаги** (наивысший приоритет)
2. **Переменные окружения** / `.env` файл
3. **Значения по умолчанию**

### Файл `.env`

Файл `.env` должен находиться **в корне проекта ai-pipeline** (рядом с `package.json`). Он загружается автоматически из директории установки, поэтому команду `ai-pipeline` можно запускать из любой папки — `.env` будет найден корректно.

```env
# Обязательный — API-ключ Anthropic
ANTHROPIC_API_KEY=sk-ant-api03-...

# Модель Claude (по умолчанию: claude-sonnet-4-20250514)
AI_PIPELINE_MODEL=claude-sonnet-4-20250514

# Максимальное количество попыток кодера (по умолчанию: 3)
AI_PIPELINE_MAX_ATTEMPTS=3

# Автоматический мерж в main (по умолчанию: false)
AI_PIPELINE_AUTO_MERGE=false

# Путь к файлу SQLite базы данных (по умолчанию: ./ai-pipeline.db)
AI_PIPELINE_DB_PATH=./ai-pipeline.db
```

### Объект конфигурации (`AppConfig`)

```typescript
interface AppConfig {
  anthropicApiKey: string;  // API-ключ Anthropic (обязательный)
  model: string;            // Модель Claude
  maxAttempts: number;      // Макс. попыток кодера
  autoMerge: boolean;       // Автомерж в main
  dbPath: string;           // Путь к SQLite файлу
}
```

Конфигурация кешируется после первого вызова. Файл: `src/config.ts`.

---

## CLI-команды

### `run` — Запуск задачи

Основная команда. Создаёт задачу и прогоняет её через полный конвейер.

```bash
ai-pipeline run <описание> --repo <путь> [опции]
```

**Аргументы:**

| Параметр | Тип | Обязательный | Описание |
|----------|-----|:------------:|----------|
| `<описание>` | строка | да | Текстовое описание задачи на любом языке |
| `--repo <путь>` | путь | да | Абсолютный или относительный путь к целевому git-репозиторию |
| `--model <модель>` | строка | нет | Модель Claude (по умолчанию из .env или `claude-sonnet-4-20250514`) |
| `--max-attempts <n>` | число | нет | Максимальное количество попыток (по умолчанию: 3) |
| `--auto-merge` | флаг | нет | Автоматический мерж в main-ветку при успехе |

**Примеры:**

```bash
# Базовое использование
ai-pipeline run "добавь кнопку логаута в хедер" --repo ~/projects/my-app

# С автомержем и кастомной моделью
ai-pipeline run "исправь баг с валидацией email" --repo ./my-app --auto-merge --model claude-sonnet-4-20250514

# С ограничением попыток
ai-pipeline run "добавь тёмную тему" --repo ~/projects/my-app --max-attempts 5
```

**Что происходит:**

1. Создаётся запись задачи в SQLite (статус: `pending`)
2. Проверяется, что репозиторий чистый (нет незакоммиченных изменений)
3. Запускается цикл попыток (до `maxAttempts`):
   - **Coding**: собирается контекст репо → вызывается Coder Agent → файлы записываются → коммит в ветку `ai/task-{id}-attempt-{n}`
   - **Reviewing**: получается git diff → вызывается Reviewer Agent → при reject — сохраняется фидбек, цикл продолжается
   - **Testing**: запускается lint + тесты → при fail — сохраняется вывод, цикл продолжается
   - **Merge**: если `--auto-merge` — мерж в main, иначе ветка остаётся для ручного мержа
4. Процесс завершается с exit code 0 (успех) или 1 (ошибка)

**Коды завершения:**

| Код | Значение |
|-----|----------|
| 0 | Задача успешно завершена (`done`) |
| 1 | Задача провалилась (`failed`) или произошла ошибка |

---

### `tasks` — Список задач

Выводит все задачи из базы данных.

```bash
ai-pipeline tasks [--status <статус>]
```

**Опции:**

| Параметр | Описание |
|----------|----------|
| `--status <статус>` | Фильтр по статусу: `pending`, `coding`, `reviewing`, `testing`, `done`, `failed` |

**Примеры:**

```bash
# Все задачи
ai-pipeline tasks

# Только завершённые
ai-pipeline tasks --status done

# Только упавшие
ai-pipeline tasks --status failed
```

**Вывод:**

```
────────────────────────────────────────────────────────────
 Tasks
────────────────────────────────────────────────────────────
 #3 [done] добавь кнопку логаута в хедер
 #2 [failed] исправь баг с пагинацией
 #1 [done] добавь валидацию email
```

---

### `show` — Детали задачи

Показывает полную информацию о задаче: статус, ветку, попытки, ошибки, фидбек ревьюера и логи всех агентов.

```bash
ai-pipeline show <task-id>
```

**Пример:**

```bash
ai-pipeline show 1
```

**Вывод:**

```
────────────────────────────────────────────────────────────
 Task #1
────────────────────────────────────────────────────────────
  Title:       добавь валидацию email
  Status:      done
  Repository:  /Users/user/projects/my-app
  Branch:      ai/task-1-attempt-2
  Attempt:     2/3
  Created:     2025-01-15 10:30:00
  Updated:     2025-01-15 10:32:45

────────────────────────────────────────────────────────────
 Agent Logs
────────────────────────────────────────────────────────────
  [2025-01-15 10:30:05] coder/generate
    Input:  Task: добавь валидацию email
    Output: 2 files, commit: feat: add email validation to registration form
    Tokens: 15230
    Duration: 8500ms
  [2025-01-15 10:30:15] reviewer/review
    Input:  Diff: 3200 chars
    Output: reject: Missing edge case for empty string
    Tokens: 4100
    Duration: 3200ms
  [2025-01-15 10:30:20] coder/generate
    Input:  Task: добавь валидацию email + feedback
    Output: 2 files, commit: feat: add email validation with edge case handling
    Tokens: 16800
    Duration: 9100ms
  [2025-01-15 10:30:30] reviewer/review
    Input:  Diff: 3500 chars
    Output: approve: Clean implementation with proper validation
    Tokens: 3800
    Duration: 2900ms
  [2025-01-15 10:30:45] tester/test
    Output: All checks passed
  [2025-01-15 10:30:45] pipeline/complete
    Output: Branch ready: ai/task-1-attempt-2
```

---

### `retry` — Повтор упавшей задачи

Перезапускает задачу в статусе `failed`. Создаёт новую задачу с тем же описанием.

```bash
ai-pipeline retry <task-id> [опции]
```

**Опции:**

| Параметр | Описание |
|----------|----------|
| `--repo <путь>` | Переопределить путь к репозиторию |
| `--model <модель>` | Использовать другую модель Claude |
| `--max-attempts <n>` | Изменить лимит попыток |
| `--auto-merge` | Включить автомерж |

**Пример:**

```bash
# Повторить с теми же параметрами
ai-pipeline retry 2

# Повторить с другой моделью и большим числом попыток
ai-pipeline retry 2 --model claude-sonnet-4-20250514 --max-attempts 5
```

---

## Жизненный цикл задачи

Каждая задача проходит через строго определённые статусы:

```
pending → coding → reviewing → testing → done
                      │            │
                      │ (reject)   │ (fail)
                      ▼            ▼
                   coding ← ── coding    (следующая попытка)
                      │
                      │ (все попытки исчерпаны)
                      ▼
                    failed
```

| Статус | Описание |
|--------|----------|
| `pending` | Задача создана, ожидает запуска |
| `coding` | Coder Agent генерирует код |
| `reviewing` | Reviewer Agent проверяет diff |
| `testing` | Запущены lint и тесты |
| `done` | Задача успешно завершена |
| `failed` | Все попытки исчерпаны или произошла критическая ошибка |

### Механизм повторных попыток

При каждой попытке:

1. Создаётся **чистая ветка** от main: `ai/task-{id}-attempt-{n}`
2. Кодер получает **обратную связь** от предыдущей попытки (если есть):
   - Комментарии ревьюера (какие issues найдены)
   - Вывод упавших тестов/линтера
3. Контекст репозитория собирается **заново** (на случай если main изменился)

Если все попытки исчерпаны — задача переходит в статус `failed` с сообщением об ошибке.

---

## Агенты

### Coder Agent

**Файл:** `src/agents/coder.ts`

**Роль:** Senior-разработчик. Получает контекст проекта + описание задачи + (опционально) обратную связь с предыдущей попытки.

**Системный промпт:**
- Следовать существующим паттернам и стилю кода проекта
- Делать минимальные, сфокусированные изменения
- Предпочитать редактирование существующих файлов созданию новых
- Не вводить уязвимости безопасности
- Отвечать строго в JSON-формате

**Формат ответа:**

```json
{
  "thinking": "Краткое объяснение подхода",
  "files": [
    {
      "path": "relative/path/to/file.ts",
      "action": "create | update | delete",
      "content": "полное содержимое файла"
    }
  ],
  "commitMessage": "краткое сообщение коммита"
}
```

**Важно:**
- Для `update` — содержимое файла должно быть **полным** (не diff)
- Для `delete` — `content` пустая строка
- `max_tokens` = 16384 (ответ агента)

---

### Reviewer Agent

**Файл:** `src/agents/reviewer.ts`

**Роль:** Senior код-ревьюер. Получает **только git diff** — не знает исходную задачу. Оценивает код исключительно по технической качеству.

**Системный промпт:**
- Проверять баги, уязвимости, сломанные API, критичные проблемы с производительностью
- REJECT только при критичных проблемах (баги, дыры безопасности, сломанные контракты)
- APPROVE код, который работает корректно, даже если не идеален

**Формат ответа:**

```json
{
  "decision": "approve | reject",
  "issues": [
    {
      "severity": "critical | major | minor | nit",
      "file": "path/to/file",
      "line": null,
      "message": "описание проблемы"
    }
  ],
  "summary": "Краткая общая оценка"
}
```

**Уровни серьёзности issues:**

| Уровень | Описание | Вызывает reject? |
|---------|----------|:----------------:|
| `critical` | Баги, уязвимости, сломанные API | да |
| `major` | Серьёзные проблемы, но не критичные | нет |
| `minor` | Мелкие недочёты | нет |
| `nit` | Стилистические замечания | нет |

---

### Test Runner

**Файл:** `src/test-runner/executor.ts`

**Роль:** Запускает lint и тесты целевого проекта через `child_process`.

**Логика работы:**

1. **Определение пакетного менеджера**: ищет `pnpm-lock.yaml` → `yarn.lock` → по умолчанию `npm`
2. **Lint**: если в `package.json` есть скрипт `lint` — запускает `{pm} run lint`
3. **Тесты**: если в `package.json` есть скрипт `test` — запускает `{pm} run test`
4. Если скрипт не найден — этап пропускается (считается пройденным)

**Таймаут**: 2 минуты на каждую команду.

**Результат:**

```typescript
interface TestResult {
  passed: boolean;     // lint И тесты прошли
  lintOutput: string;  // stdout + stderr линтера
  testOutput: string;  // stdout + stderr тестов
  summary: string;     // "All checks passed" или описание ошибок
}
```

---

## Сбор контекста репозитория

**Файлы:** `src/context/gatherer.ts`, `src/context/filters.ts`, `src/utils/tokens.ts`

Перед каждым вызовом Coder Agent система собирает контекст целевого репозитория. Контекст формируется в 4 уровня приоритета:

### Уровень 1: Метаданные проекта (бюджет: ~5000 токенов)

Читаются конфигурационные файлы из корня репозитория:

| Файл | Назначение |
|------|-----------|
| `package.json` | Зависимости, скрипты, тип проекта |
| `tsconfig.json`, `tsconfig.app.json` | Настройки TypeScript |
| `.eslintrc*`, `eslint.config.*` | Настройки линтера |
| `nuxt.config.*` | Конфиг Nuxt.js |
| `next.config.*` | Конфиг Next.js |
| `vite.config.*` | Конфиг Vite |
| `vue.config.js` | Конфиг Vue CLI |
| `README.md` | Документация проекта |
| `CLAUDE.md` | Инструкции для AI |

### Уровень 2: Дерево файлов (бюджет: ~5000 токенов)

Полная структура файлов репозитория (без игнорируемых). Ограничения:
- Максимум **500 записей**
- Максимальная глубина **6 уровней**

### Уровень 3: Ключевые файлы (бюджет: ~30000 токенов)

Содержимое важных файлов:
- **Entry points**: `src/main.ts`, `src/index.ts`, `src/App.vue`, `app.vue`, `pages/index.vue` и т.д.
- **Файлы, упомянутые в задаче**: если слово из описания задачи (длиннее 3 символов) совпадает с именем файла
- **Типы**: файлы `*.d.ts`, `types.ts`, содержимое директорий `types/`

### Уровень 4: Расширение по импортам (бюджет: ~20000 токенов)

Анализируются `import`/`from` в ключевых файлах. Относительные импорты (`./`, `../`) резолвятся до реальных файлов и добавляются в контекст.

### Фильтрация файлов

**Игнорируемые директории:**
`node_modules`, `.git`, `dist`, `build`, `.next`, `.nuxt`, `.output`, `.cache`, `.turbo`, `coverage`, `.vercel`, `.netlify`, `__pycache__`, `vendor`, а также все директории начинающиеся с `.`

**Игнорируемые расширения:**
`.lock`, `.png`, `.jpg`, `.jpeg`, `.gif`, `.svg`, `.ico`, `.webp`, `.woff`, `.woff2`, `.ttf`, `.eot`, `.mp3`, `.mp4`, `.avi`, `.mov`, `.zip`, `.tar`, `.gz`, `.rar`, `.pdf`, `.doc`, `.docx`, `.db`, `.sqlite`, `.min.js`, `.min.css`, `.map`

### Бюджет токенов

Оценка: **1 токен ~ 4 символа** (упрощённая оценка).

| Категория | Бюджет (токенов) |
|-----------|:----------------:|
| Общий контекст | 80 000 |
| Контекст репозитория | 60 000 |
| Метаданные | 5 000 |
| Дерево файлов | 5 000 |
| Ключевые файлы | 30 000 |
| Дополнительные файлы | 20 000 |

Каждый уровень обрезается по бюджету. Файлы крупнее 100 КБ усекаются.

---

## База данных

**Файлы:** `src/db/sqlite.ts`, `src/db/tasks.ts`

Используется **SQLite** через `better-sqlite3` (синхронный драйвер). Файл БД создаётся автоматически при первом запуске.

### Таблица `tasks`

| Колонка | Тип | Описание |
|---------|-----|----------|
| `id` | INTEGER PK | Автоинкрементный ID |
| `title` | TEXT | Заголовок задачи (первые 100 символов описания) |
| `description` | TEXT | Полное описание задачи |
| `status` | TEXT | Текущий статус: `pending`/`coding`/`reviewing`/`testing`/`done`/`failed` |
| `repo_path` | TEXT | Абсолютный путь к репозиторию |
| `branch_name` | TEXT | Имя текущей ветки (`ai/task-{id}-attempt-{n}`) |
| `attempt` | INTEGER | Номер текущей попытки |
| `max_attempts` | INTEGER | Максимальное число попыток |
| `reviewer_feedback` | TEXT | Последний фидбек ревьюера или вывод упавших тестов |
| `error_message` | TEXT | Сообщение об ошибке (при `failed`) |
| `created_at` | TEXT | Дата создания (UTC) |
| `updated_at` | TEXT | Дата последнего обновления (UTC) |

### Таблица `task_logs`

| Колонка | Тип | Описание |
|---------|-----|----------|
| `id` | INTEGER PK | Автоинкрементный ID |
| `task_id` | INTEGER FK | Ссылка на задачу |
| `agent` | TEXT | Роль агента: `coder`/`reviewer`/`tester`/`pipeline` |
| `action` | TEXT | Действие: `generate`, `review`, `test`, `complete` |
| `input_summary` | TEXT | Краткое описание входных данных |
| `output_summary` | TEXT | Краткое описание результата |
| `tokens_used` | INTEGER | Количество использованных токенов (input + output) |
| `duration_ms` | INTEGER | Длительность в миллисекундах |
| `created_at` | TEXT | Дата записи (UTC) |

### Настройки SQLite

- **WAL mode** — для лучшей производительности при конкурентном доступе
- **Foreign keys ON** — каскадное удаление логов при удалении задачи
- **Индексы**: по `tasks.status` и `task_logs.task_id`

### TaskRepository API

```typescript
class TaskRepository {
  create(params: { title, description, repoPath, maxAttempts }): TaskRecord
  getById(id: number): TaskRecord | undefined
  list(status?: TaskStatus): TaskRecord[]
  updateStatus(id: number, status: TaskStatus): void
  updateAttempt(id: number, attempt: number, branchName: string): void
  setReviewerFeedback(id: number, feedback: string): void
  setError(id: number, error: string): void
  addLog(params: { taskId, agent, action, inputSummary?, outputSummary?, tokensUsed?, durationMs? }): void
  getLogs(taskId: number): TaskLogRecord[]
}
```

---

## Git-операции

**Файл:** `src/git/operations.ts`

Используется библиотека `simple-git`.

### Методы `GitOperations`

| Метод | Описание |
|-------|----------|
| `ensureClean()` | Проверяет, что нет незакоммиченных изменений. Выбрасывает ошибку, если есть |
| `getCurrentBranch()` | Возвращает имя текущей ветки |
| `getDefaultBranch()` | Определяет основную ветку: пробует `origin/HEAD`, затем ищет `main`/`master` |
| `createBranch(name)` | Переключается на main, делает pull, удаляет ветку если существует, создаёт новую |
| `commitAll(message)` | `git add . && git commit -m "..."` |
| `getDiff(base?)` | `git diff {base}...HEAD` |
| `mergeBranch(name)` | Мержит ветку в основную с `--no-ff` |
| `checkoutBranch(name)` | Переключает на указанную ветку |
| `getLastCommitHash()` | Возвращает хеш последнего коммита |

### Именование веток

Формат: `ai/task-{taskId}-attempt-{attemptNumber}`

Пример: `ai/task-3-attempt-2` — вторая попытка третьей задачи.

Каждая попытка создаёт **чистую ветку** от main (предыдущая ветка удаляется, если существовала).

---

## Структура проекта

```
ai-pipeline/
├── package.json              # Зависимости и скрипты
├── tsconfig.json             # Конфигурация TypeScript (ESM, strict)
├── .gitignore                # Игнорируемые файлы
├── .env.example              # Пример переменных окружения
├── .env                      # Реальные переменные (не в git)
├── ai-pipeline.db            # SQLite база данных (создаётся автоматически)
├── src/
│   ├── index.ts              # CLI точка входа (commander)
│   ├── config.ts             # Загрузка и кеширование конфигурации
│   ├── pipeline/
│   │   ├── types.ts          # Все общие TypeScript типы
│   │   └── runner.ts         # Оркестратор — стейт-машина пайплайна
│   ├── agents/
│   │   ├── base.ts           # BaseAgent — общая логика вызова Claude API
│   │   ├── coder.ts          # CoderAgent — генерация кода
│   │   ├── reviewer.ts       # ReviewerAgent — код-ревью
│   │   └── prompts.ts        # Системные промпты и билдеры пользовательских
│   ├── context/
│   │   ├── gatherer.ts       # Сбор контекста репозитория (4 уровня)
│   │   └── filters.ts        # Фильтрация файлов (ignore, binary)
│   ├── db/
│   │   ├── sqlite.ts         # Инициализация БД, создание таблиц
│   │   └── tasks.ts          # TaskRepository — CRUD операции
│   ├── git/
│   │   └── operations.ts     # Git-операции через simple-git
│   ├── test-runner/
│   │   └── executor.ts       # Запуск lint + тестов через child_process
│   └── utils/
│       ├── logger.ts         # Логирование (chalk + ora спиннеры)
│       └── tokens.ts         # Оценка токенов и управление бюджетом
└── dist/                     # Скомпилированный JS (создаётся при build)
```

---

## Подробное описание каждого модуля

### `src/index.ts` — CLI точка входа

Использует библиотеку `commander` для разбора аргументов командной строки. Определяет 4 команды: `run`, `tasks`, `show`, `retry`. Каждая команда:
1. Загружает конфигурацию через `getConfig()` с учётом CLI-флагов
2. Открывает SQLite базу данных
3. Выполняет действие
4. Закрывает БД в блоке `finally`
5. Устанавливает код завершения процесса

Содержит shebang `#!/usr/bin/env node` для использования как исполняемый файл.

### `src/config.ts` — Конфигурация

Загружает `.env` из **корня проекта ai-pipeline** (определяется через `import.meta.url`, а не из текущей рабочей директории). Строит объект `AppConfig` из переменных окружения и переданных переопределений (overrides). Кеширует конфигурацию — повторные вызовы `getConfig()` без overrides возвращают кешированный объект. Бросает ошибку, если `ANTHROPIC_API_KEY` не задан.

### `src/pipeline/types.ts` — Типы

Центральный файл типов. Определяет:
- `TaskStatus` — 6 возможных статусов задачи
- `AgentRole` — роли агентов (`coder`, `reviewer`, `tester`, `pipeline`)
- `TaskRecord` — полная запись задачи из БД
- `TaskLogRecord` — запись лога агента
- `FileChange` — описание изменения файла (path, action, content)
- `CoderOutput` — формат ответа кодера (thinking, files, commitMessage)
- `ReviewIssue` — одна проблема из ревью (severity, file, line, message)
- `ReviewerOutput` — формат ответа ревьюера (decision, issues, summary)
- `TestResult` — результат запуска тестов
- `PipelineOptions` — параметры запуска пайплайна
- `RepoContext` — собранный контекст репозитория

### `src/pipeline/runner.ts` — Оркестратор

Класс `PipelineRunner` — сердце системы. Метод `run()`:
1. Создаёт задачу в БД
2. Проверяет чистоту репозитория
3. Для каждой попытки:
   - Создаёт чистую ветку от main
   - Вызывает `CoderAgent.generate()` с контекстом + фидбеком
   - Записывает сгенерированные файлы на диск
   - Коммитит изменения
   - Вызывает `ReviewerAgent.review()` с diff
   - При reject — сохраняет фидбек, продолжает цикл
   - Запускает lint + тесты через `runTests()`
   - При fail — сохраняет вывод, продолжает цикл
   - При успехе — мержит (если autoMerge) или оставляет ветку
4. Логирует каждое действие в `task_logs`
5. Обновляет статус задачи на каждом шагу

Метод `retry()` перезапускает задачу в статусе `failed`.

### `src/agents/base.ts` — Базовый агент

Класс `BaseAgent` — абстракция для взаимодействия с Claude API:
- Инициализирует клиент `@anthropic-ai/sdk`
- Метод `call()` — отправляет system prompt + user prompt, возвращает текст ответа и счётчики токенов
- Метод `parseJSON()` — парсит ответ как JSON, автоматически убирая markdown code fences
- `max_tokens` = 16384 для всех агентов

### `src/agents/coder.ts` — Агент-кодер

Наследует `BaseAgent`. Метод `generate()`:
1. Формирует user prompt из контекста + задачи + фидбека
2. Вызывает Claude API
3. Парсит JSON-ответ
4. Валидирует структуру (наличие `files`, `commitMessage`)
5. Возвращает результат + метрики (tokensUsed, durationMs)

### `src/agents/reviewer.ts` — Агент-ревьюер

Наследует `BaseAgent`. Метод `review()`:
1. Формирует user prompt с diff
2. Вызывает Claude API
3. Парсит JSON-ответ
4. Валидирует решение (`approve`/`reject`)
5. Возвращает результат + метрики

### `src/agents/prompts.ts` — Промпты

Содержит:
- `CODER_SYSTEM_PROMPT` — системный промпт кодера с правилами и форматом ответа
- `REVIEWER_SYSTEM_PROMPT` — системный промпт ревьюера с критериями и форматом
- `buildCoderUserPrompt()` — собирает пользовательский промпт из контекста + задачи + фидбека
- `buildReviewerUserPrompt()` — оборачивает diff в промпт для ревью

### `src/context/gatherer.ts` — Сборщик контекста

Функция `gatherContext()` — собирает полный контекст репозитория в 4 этапа:
1. `gatherMetadata()` — читает конфиги проекта
2. `buildFileTree()` — рекурсивный обход файловой системы с фильтрацией
3. `gatherKeyFiles()` — определяет и читает ключевые файлы
4. `gatherExtraFiles()` — резолвит импорты из ключевых файлов

Функция `formatContextForPrompt()` — форматирует контекст в текст для промпта с markdown-разметкой.

### `src/context/filters.ts` — Фильтры

Наборы правил для фильтрации файловой системы:
- `shouldIgnoreDir()` — проверка директории по чёрному списку
- `shouldIgnoreFile()` — проверка файла по расширению
- `isBinaryFile()` — определение бинарных файлов
- `safeReadFile()` — безопасное чтение с лимитом размера (100 КБ)
- `METADATA_FILES` — список конфигурационных файлов проекта
- `ENTRY_POINT_PATTERNS` — паттерны точек входа

### `src/db/sqlite.ts` — Инициализация БД

- `getDatabase()` — создаёт/открывает БД, включает WAL mode и foreign keys, создаёт таблицы
- `createTables()` — SQL для создания `tasks` и `task_logs` с индексами
- `closeDatabase()` — корректное закрытие соединения
- Singleton-паттерн — база открывается один раз за процесс

### `src/db/tasks.ts` — Репозиторий задач

Класс `TaskRepository` — все CRUD-операции с задачами и логами через prepared statements. Все методы синхронные (better-sqlite3).

### `src/git/operations.ts` — Git

Класс `GitOperations` — обёртка над `simple-git` с методами для полного цикла:
- Определение основной ветки (поддержка main и master)
- Создание чистых веток от основной
- Pull с graceful fallback (работает offline)
- No-fast-forward merge для сохранения истории

### `src/test-runner/executor.ts` — Тест-раннер

Функция `runTests()`:
- Автоматически определяет пакетный менеджер (npm/yarn/pnpm)
- Проверяет наличие скриптов `lint` и `test` в `package.json`
- Запускает команды через `child_process.execFile` с shell mode
- Таймаут 2 минуты на команду
- Возвращает структурированный результат

### `src/utils/logger.ts` — Логирование

Класс `Logger` с методами:
- `info()`, `success()`, `warn()`, `error()` — цветной вывод через chalk
- `debug()` — выводится только при `DEBUG=1` в окружении
- `spin()` — ora-спиннер для длительных операций
- `header()`, `divider()` — форматирование секций
- `taskStatus()` — цветной вывод статуса задачи

Автоматически останавливает спиннер перед выводом текста.

### `src/utils/tokens.ts` — Управление токенами

- `estimateTokens()` — оценка количества токенов по длине текста (1 токен ~ 4 символа)
- `fitWithinBudget()` — отбирает файлы из Map, пока не исчерпан бюджет
- `truncateToTokenBudget()` — обрезает текст по бюджету
- `TOKEN_BUDGETS` — константы бюджетов для каждой категории контекста

---

## Переменные окружения

| Переменная | Обязательная | По умолчанию | Описание |
|-----------|:----:|-------------|----------|
| `ANTHROPIC_API_KEY` | да | — | API-ключ Anthropic |
| `AI_PIPELINE_MODEL` | нет | `claude-sonnet-4-20250514` | Модель Claude |
| `AI_PIPELINE_MAX_ATTEMPTS` | нет | `3` | Макс. попыток кодера |
| `AI_PIPELINE_AUTO_MERGE` | нет | `false` | Автомерж в main |
| `AI_PIPELINE_DB_PATH` | нет | `./ai-pipeline.db` | Путь к SQLite файлу |
| `DEBUG` | нет | — | Включить debug-логи (любое значение) |

---

## Примеры использования

### Простая задача

```bash
ai-pipeline run "добавь компонент кнопки логаута в Header.vue" --repo ~/projects/my-app
```

### С автомержем

```bash
ai-pipeline run "исправь баг: форма не валидирует пустой email" --repo ~/projects/my-app --auto-merge
```

### С отладкой

```bash
DEBUG=1 ai-pipeline run "добавь пагинацию в список пользователей" --repo ~/projects/my-app
```

### Просмотр результатов

```bash
# Список всех задач
ai-pipeline tasks

# Только упавшие
ai-pipeline tasks --status failed

# Детали задачи с логами агентов
ai-pipeline show 1

# Повторить упавшую задачу
ai-pipeline retry 2 --max-attempts 5
```

### Ручной мерж после успешного прогона

```bash
# Запуск без автомержа (по умолчанию)
ai-pipeline run "добавь тёмную тему" --repo ~/projects/my-app

# Посмотреть ветку
ai-pipeline show 1
# Branch: ai/task-1-attempt-1

# Перейти в репозиторий и замержить вручную
cd ~/projects/my-app
git merge ai/task-1-attempt-1 --no-ff
```

---

## Устранение неполадок

### `ANTHROPIC_API_KEY is required`

Убедитесь, что файл `.env` создан в **корне проекта ai-pipeline** (рядом с `package.json`) и содержит валидный ключ. Файл загружается из директории установки, а не из текущей рабочей папки. Альтернативно — задайте переменную окружения напрямую: `export ANTHROPIC_API_KEY=sk-ant-...`

### `Repository has uncommitted changes`

Перед запуском пайплайна в целевом репозитории не должно быть незакоммиченных изменений:

```bash
cd ~/projects/my-app
git stash   # или git commit
```

### Задача зависла на `coding`

Claude API может отвечать долго (до 60 секунд). Если процесс зависает — проверьте сетевое соединение и валидность API-ключа.

### `Coder returned invalid JSON`

Иногда модель возвращает ответ не в формате JSON. Пайплайн выбросит ошибку и задача перейдёт в `failed`. Используйте `retry` для повтора.

### Тесты не запускаются

Тест-раннер ищет скрипты `lint` и `test` в `package.json` целевого проекта. Если их нет — этапы пропускаются (считаются пройденными).

---

## Технический стек

| Пакет | Версия | Назначение |
|-------|--------|-----------|
| TypeScript | ^5.7 | Язык (ESM, strict mode) |
| @anthropic-ai/sdk | ^0.39 | Claude API клиент |
| better-sqlite3 | ^11.7 | SQLite драйвер (синхронный) |
| simple-git | ^3.27 | Git-операции |
| commander | ^13.1 | CLI-парсер |
| chalk | ^5.4 | Цветной вывод в терминал |
| ora | ^8.1 | Спиннеры для длительных операций |
| glob | ^11.0 | Поиск файлов по паттернам |
| dotenv | ^16.4 | Загрузка .env файлов |
